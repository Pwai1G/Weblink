<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebLinkUser</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
        color: #333;
      }
      .container {
        height: auto;
        padding: 1px;
        display: flex;
      }

      .left {
        width: 80%;
        padding: 20px;
        overflow-y: auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .right {
        width: auto;
        background-color: #f4f4f4;
        padding: 20px;
        font-size: 12px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }

      th,
      td {
        border: 1px solid black;
        padding: 10px;
        text-align: center;
        width: 80%;
      }

      th {
        background-color: #f4f4f4;
      }

      button {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 10px;
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }

      button:hover {
        background: linear-gradient(135deg, #0056b3, #003f7f);
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left">
        <h2 style="text-align: center; display: inline-block">
          Link Management
        </h2>
        <button id="refreshButton" onclick="refreshPage()">üîÑ Refresh</button>
        <p id="lastUpdated">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</p>
        <div id="tables-container"></div>
      </div>

      <div class="right">
        <h2>Manage Data</h2>
        <input
          type="file"
          id="importFile"
          style="display: none"
          accept=".json"
        />
        <button onclick="importDefaultData()">Import Link</button>
        <h3>Clear Screen</h3>
        <button onclick="clearScreen()">Clear Screen</button>
        <h3>Clear Cache</h3>
        <button onclick="clearCache()">Clear Cache</button>
        <div><br /></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ JavaScript Loaded!");
        document
          .getElementById("refreshButton")
          .addEventListener("click", function () {
            location.reload();
          });
        loadTables();
      });

      document.addEventListener("DOMContentLoaded", function () {
        fetchLastUpdateTime();
      });

      function loadTables() {
        const tablesContainer = document.getElementById("tables-container");
        const tables = JSON.parse(localStorage.getItem("tables")) || [];
        const links = JSON.parse(localStorage.getItem("links")) || {};
        tablesContainer.innerHTML = "";
        tables.forEach((tableName) => {
          const tableDiv = document.createElement("div");
          tableDiv.innerHTML = `<h3>${tableName}</h3>`;

          const table = document.createElement("table");
          table.innerHTML = `
            <thead>
              <tr>
                <th>Name</th>
                <th>Link</th>
              </tr>
            </thead>
            <tbody>
              ${
                links[tableName]
                  ? links[tableName]
                      .map(
                        (link) => `
                <tr>
                  <td>${link.name}</td>
                  <td><button onclick="window.open('${link.url}', '_blank')">Click</button></td>
                </tr>
              `
                      )
                      .join("")
                  : ""
              }
            </tbody>
          `;

          tableDiv.appendChild(table);
          tablesContainer.appendChild(tableDiv);
        });
      }

      function exportData() {
        const data = {
          tables: JSON.parse(localStorage.getItem("tables")) || [],
          links: JSON.parse(localStorage.getItem("links")) || {},
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "table_data.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importData() {
        const fileInput = document.getElementById("importFile");
        fileInput.click();
        fileInput.onchange = function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem("tables", JSON.stringify(data.tables));
                localStorage.setItem("links", JSON.stringify(data.links));
                location.reload();
              } catch (error) {
                alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
              }
            };
            reader.readAsText(file);
          }
        };
      }

      function clearScreen() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
          localStorage.removeItem("tables");
          localStorage.removeItem("links");
          location.reload();
        }
      }

      function logout() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          localStorage.removeItem("loggedIn");
          window.location.href = "login.html";
        }
      }
      function importDefaultData() {
        console.log("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Default Data...");

        fetch("https://pwai1g.github.io/Weblink/Default_List.json", {
          cache: "no-cache",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Default_List.json ‡πÑ‡∏î‡πâ");
            }
            return response.json();
          })
          .then((data) => {
            if (data.tables && data.links) {
              localStorage.setItem("tables", JSON.stringify(data.tables));
              localStorage.setItem("links", JSON.stringify(data.links));

              console.log("‚úÖ Default Data ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
              alert("Import Default ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
              location.reload();
            } else {
              alert("‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå Default_List.json ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            }
          })
          .catch((error) => {
            console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Default_List.json");
          });
      }
      function clearCache() {
        const confirmClear = window.confirm(
          "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?"
        );

        if (confirmClear) {
          // üî¥ ‡∏•‡πâ‡∏≤‡∏á Local Storage
          localStorage.removeItem("tables");
          localStorage.removeItem("links");
          localStorage.clear();

          // üî¥ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
          caches.keys().then((names) => {
            names.forEach((name) => caches.delete(name));
          });

          // üîÑ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î JSON ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
          location.reload(true);
        }
      }

      function fetchLastUpdateTime() {
        const repoOwner = "pwai1g"; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á repo
        const repoName = "Weblink"; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ repo
        const filePath = "Default_List.json"; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/commits?path=${filePath}`;

        fetch(apiUrl)
          .then((response) => {
            if (!response.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• commit");
            return response.json();
          })
          .then((data) => {
            if (data.length > 0) {
              const lastCommitDate = new Date(
                data[0].commit.committer.date
              ).toLocaleString("th-TH", { timeZone: "Asia/Bangkok" });
              document.getElementById(
                "lastUpdated"
              ).innerHTML = `üîÑ Last Default Update: ${lastCommitDate}`;
            } else {
              document.getElementById("lastUpdated").innerHTML =
                "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• commit";
            }
          })
          .catch((error) => {
            console.error("‚ùå Fetch Error:", error);
            document.getElementById("lastUpdated").innerHTML =
              "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
          });
      }
    </script>
  </body>
</html>
